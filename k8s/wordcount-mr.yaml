# =========================
# Namespace
# =========================
apiVersion: v1
kind: Namespace
metadata:
  name: wordcount-mr

---
# =========================
# ConfigMap: Worker Count
# =========================
apiVersion: v1
kind: ConfigMap
metadata:
  name: wordcount-config
  namespace: wordcount-mr
data:
  NUM_WORKERS: "3" # Change this to the number of workers your client should use

---
# =========================
# Worker Deployments & Services
# =========================

# Worker template: you can duplicate/change WORKER_ID and names
# Worker 1
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mr-worker1-deployment
  namespace: wordcount-mr
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mr-worker1
  template:
    metadata:
      labels:
        app: mr-worker1
    spec:
      containers:
        - name: worker
          image: wordcount-mapreduce-worker:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 50051
          env:
            - name: WORKER_ID
              value: "1"

---
apiVersion: v1
kind: Service
metadata:
  name: worker1
  namespace: wordcount-mr
spec:
  selector:
    app: mr-worker1
  ports:
    - protocol: TCP
      port: 50051
      targetPort: 50051

---
# Worker 2
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mr-worker2-deployment
  namespace: wordcount-mr
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mr-worker2
  template:
    metadata:
      labels:
        app: mr-worker2
    spec:
      containers:
        - name: worker
          image: wordcount-mapreduce-worker:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 50051
          env:
            - name: WORKER_ID
              value: "2"

---
apiVersion: v1
kind: Service
metadata:
  name: worker2
  namespace: wordcount-mr
spec:
  selector:
    app: mr-worker2
  ports:
    - protocol: TCP
      port: 50051
      targetPort: 50051

---
# Worker 3
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mr-worker3-deployment
  namespace: wordcount-mr
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mr-worker3
  template:
    metadata:
      labels:
        app: mr-worker3
    spec:
      containers:
        - name: worker
          image: wordcount-mapreduce-worker:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 50051
          env:
            - name: WORKER_ID
              value: "3"

---
apiVersion: v1
kind: Service
metadata:
  name: worker3
  namespace: wordcount-mr
spec:
  selector:
    app: mr-worker3
  ports:
    - protocol: TCP
      port: 50051
      targetPort: 50051

---
# Worker 4
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mr-worker4-deployment
  namespace: wordcount-mr
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mr-worker4
  template:
    metadata:
      labels:
        app: mr-worker4
    spec:
      containers:
        - name: worker
          image: wordcount-mapreduce-worker:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 50051
          env:
            - name: WORKER_ID
              value: "4"

---
apiVersion: v1
kind: Service
metadata:
  name: worker4
  namespace: wordcount-mr
spec:
  selector:
    app: mr-worker4
  ports:
    - protocol: TCP
      port: 50051
      targetPort: 50051

---
# Worker 5
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mr-worker5-deployment
  namespace: wordcount-mr
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mr-worker5
  template:
    metadata:
      labels:
        app: mr-worker5
    spec:
      containers:
        - name: worker
          image: wordcount-mapreduce-worker:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 50051
          env:
            - name: WORKER_ID
              value: "5"

---
apiVersion: v1
kind: Service
metadata:
  name: worker5
  namespace: wordcount-mr
spec:
  selector:
    app: mr-worker5
  ports:
    - protocol: TCP
      port: 50051
      targetPort: 50051

---
# Worker 6
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mr-worker6-deployment
  namespace: wordcount-mr
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mr-worker6
  template:
    metadata:
      labels:
        app: mr-worker6
    spec:
      containers:
        - name: worker
          image: wordcount-mapreduce-worker:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 50051
          env:
            - name: WORKER_ID
              value: "6"

---
apiVersion: v1
kind: Service
metadata:
  name: worker6
  namespace: wordcount-mr
spec:
  selector:
    app: mr-worker6
  ports:
    - protocol: TCP
      port: 50051
      targetPort: 50051

---
# =========================
# Client Job
# =========================
apiVersion: batch/v1
kind: Job
metadata:
  name: mr-client-job
  namespace: wordcount-mr
spec:
  template:
    spec:
      containers:
        - name: client
          image: wordcount-mapreduce-client:latest
          imagePullPolicy: IfNotPresent
          env:
            - name: NUM_WORKERS
              valueFrom:
                configMapKeyRef:
                  name: wordcount-config
                  key: NUM_WORKERS
      restartPolicy: Never
  backoffLimit: 1
